---
- name: Bootstrap ChatOps Infrastructure
  hosts: localhost
  gather_facts: false
  vars:
    project_root: "{{ playbook_dir }}/.."
    terraform_dir: "{{ project_root }}/terraform"
    ansible_dir: "{{ playbook_dir }}"

    # Default values (can be overridden)
    # aws_region will be set from terraform.tfvars or default to eu-west-1 in pre_tasks

    # Terraform outputs (populated after apply)
    terraform_outputs: {}

  pre_tasks:
    - name: Check prerequisites
      block:
        - name: Check Terraform is installed
          command: terraform version
          register: terraform_version
          changed_when: false
          failed_when: false

        - name: Fail if Terraform not found
          fail:
            msg: "Terraform not found. Please install Terraform."
          when: terraform_version.rc != 0

        - name: Check Ansible is installed
          command: which ansible
          register: ansible_check
          changed_when: false
          failed_when: false
          ignore_errors: true

        - name: Fail if Ansible not found
          fail:
            msg: "Ansible not found. Please install Ansible."
          when: ansible_check.rc != 0

        - name: Check Python 3 is installed
          command: python3 --version
          register: python_version
          changed_when: false
          failed_when: false

        - name: Fail if Python 3 not found
          fail:
            msg: "Python 3 not found. Please install Python 3."
          when: python_version.rc != 0

        - name: Check if GitHub CLI is installed
          command: which gh
          register: gh_cli_check
          changed_when: false
          failed_when: false
          ignore_errors: true

        - name: Get GitHub token from GitHub CLI (if not set in env)
          shell: gh auth token
          register: gh_token_result
          environment:
            GITHUB_TOKEN: "{{ lookup('env', 'GITHUB_TOKEN') | default('', true) }}"
          changed_when: false
          failed_when: false
          when:
            - lookup('env', 'GITHUB_TOKEN') == ''
            - gh_cli_check.rc == 0

        - name: Set GITHUB_TOKEN from GitHub CLI
          set_fact:
            github_token_from_cli: "{{ gh_token_result.stdout | trim }}"
          when:
            - lookup('env', 'GITHUB_TOKEN') == ''
            - gh_cli_check.rc == 0
            - gh_token_result.rc == 0
            - gh_token_result.stdout | trim != ''

        - name: Set GITHUB_TOKEN environment variable for playbook
          set_fact:
            github_token_value: "{{ github_token_from_cli }}"
          when:
            - github_token_from_cli is defined
            - github_token_from_cli != ''

        - name: Set GITHUB_TOKEN from environment variable
          set_fact:
            github_token_value: "{{ lookup('env', 'GITHUB_TOKEN') }}"
          when:
            - lookup('env', 'GITHUB_TOKEN') != ''
            - github_token_value is not defined

        - name: Check GITHUB_TOKEN is available
          fail:
            msg: |
              GITHUB_TOKEN not found. Please set it using one of these methods:

              1. Export environment variable:
                 export GITHUB_TOKEN=your_token

              2. Use GitHub CLI (if installed):
                 gh auth login
                 # Then run bootstrap again

              3. Create a Personal Access Token:
                 https://github.com/settings/tokens
                 (Requires 'repo' scope for private repos, 'public_repo' for public repos)
          when:
            - github_token_value is not defined or github_token_value == ''

        - name: Display prerequisites status
          debug:
            msg:
              - "âœ… Terraform: {{ terraform_version.stdout_lines[0] if terraform_version.stdout_lines is defined else terraform_version.stdout }}"
              - "âœ… Ansible: Installed"
              - "âœ… Python: {{ python_version.stdout_lines[0] if python_version.stdout_lines is defined else python_version.stdout }}"
              - "âœ… GitHub Token: {{ 'Set from GitHub CLI' if github_token_from_cli is defined and github_token_from_cli != '' else 'Set from environment' }}"

    - name: Get GitHub repository info from Terraform vars
      block:
        - name: Read terraform.tfvars
          slurp:
            src: "{{ terraform_dir }}/terraform.tfvars"
          register: tfvars_content
          when: github_owner is not defined or github_repo is not defined

        - name: Extract github_owner from terraform.tfvars
          set_fact:
            github_owner: "{{ tfvars_content.content | b64decode | regex_search('github_owner\\s*=\\s*\"([^\"]+)\"', '\\1') | first }}"
          when: (github_owner is not defined or github_owner == '') and tfvars_content is defined

        - name: Extract github_repo from terraform.tfvars
          set_fact:
            github_repo: "{{ tfvars_content.content | b64decode | regex_search('github_repo\\s*=\\s*\"([^\"]+)\"', '\\1') | first }}"
          when: (github_repo is not defined or github_repo == '') and tfvars_content is defined

        - name: Fail if GitHub info missing
          fail:
            msg: "github_owner and github_repo must be set. Either set them as variables or in terraform.tfvars"
          when: github_owner is not defined or github_repo is not defined or github_owner == '' or github_repo == ''

    - name: Read install.conf if it exists
      slurp:
        src: "{{ project_root }}/install.conf"
      register: install_conf_content
      failed_when: false
      changed_when: false

    - name: Extract values from install.conf
      block:
        - name: Extract terraform_state_bucket from install.conf
          set_fact:
            terraform_state_bucket: "{{ install_conf_content.content | b64decode | regex_search('S3_BUCKET_NAME=\"([^\"]+)\"', '\\1') | first | default('') }}"
          when: (terraform_state_bucket is not defined or terraform_state_bucket == '') and install_conf_content is defined and install_conf_content.content is defined

        - name: Extract telegram_bot_token from install.conf
          set_fact:
            telegram_bot_token: "{{ install_conf_content.content | b64decode | regex_search('TELEGRAM_BOT_TOKEN=\"([^\"]+)\"', '\\1') | first | default('') }}"
          when: (telegram_bot_token is not defined or telegram_bot_token == '') and install_conf_content is defined and install_conf_content.content is defined

        - name: Extract telegram_chat_id from install.conf
          set_fact:
            telegram_chat_id: "{{ install_conf_content.content | b64decode | regex_search('AUTHORIZED_CHAT_ID=\"([^\"]+)\"', '\\1') | first | default('') }}"
          when: (telegram_chat_id is not defined or telegram_chat_id == '') and install_conf_content is defined and install_conf_content.content is defined

    - name: Extract terraform_state_bucket from terraform.tfvars (fallback)
      set_fact:
        terraform_state_bucket: "{{ tfvars_content.content | b64decode | regex_search('terraform_backend_bucket\\s*=\\s*\"([^\"]+)\"', '\\1') | first | default('') }}"
      when: (terraform_state_bucket is not defined or terraform_state_bucket == '') and tfvars_content is defined

    - name: Set values from environment variables (fallback)
      block:
        - name: Set terraform_state_bucket from env
          set_fact:
            terraform_state_bucket: "{{ lookup('env', 'TERRAFORM_STATE_BUCKET') }}"
          when: (terraform_state_bucket is not defined or terraform_state_bucket == '') and lookup('env', 'TERRAFORM_STATE_BUCKET') != ''

        - name: Set telegram_bot_token from env
          set_fact:
            telegram_bot_token: "{{ lookup('env', 'TELEGRAM_BOT_TOKEN') }}"
          when: (telegram_bot_token is not defined or telegram_bot_token == '') and lookup('env', 'TELEGRAM_BOT_TOKEN') != ''

        - name: Set telegram_chat_id from env
          set_fact:
            telegram_chat_id: "{{ lookup('env', 'TELEGRAM_CHAT_ID') }}"
          when: (telegram_chat_id is not defined or telegram_chat_id == '') and lookup('env', 'TELEGRAM_CHAT_ID') != ''

    - name: Validate required variables
      block:
        - name: Fail if terraform_state_bucket missing
          fail:
            msg: "terraform_state_bucket must be set. Set in install.conf (S3_BUCKET_NAME), terraform.tfvars (terraform_backend_bucket), or TERRAFORM_STATE_BUCKET env var"
          when: terraform_state_bucket is not defined or terraform_state_bucket == ''

        - name: Fail if telegram_bot_token missing
          fail:
            msg: "telegram_bot_token must be set. Set in install.conf (TELEGRAM_BOT_TOKEN) or TELEGRAM_BOT_TOKEN env var"
          when: telegram_bot_token is not defined or telegram_bot_token == ''

        - name: Fail if telegram_chat_id missing
          fail:
            msg: "telegram_chat_id must be set. Set in install.conf (AUTHORIZED_CHAT_ID) or TELEGRAM_CHAT_ID env var"
          when: telegram_chat_id is not defined or telegram_chat_id == ''

  tasks:
    - name: Build Lambda ZIP files
      shell: ./build.sh
      args:
        chdir: "{{ project_root }}/lambda/{{ item }}"
      loop:
        - webhook-handler
        - ai-output-processor
        - telegram-bot
      # Always rebuild - ensures fresh artifacts for bootstrap
      # Builds are fast (~5-10s each) and bootstrap is one-time anyway

    - name: Check if terraform.tfvars exists
      stat:
        path: "{{ terraform_dir }}/terraform.tfvars"
      register: tfvars_file

    - name: Fail if terraform.tfvars missing
      fail:
        msg: "terraform.tfvars not found! Please create it from terraform.tfvars.example"
      when: not tfvars_file.stat.exists

    - name: Check if Terraform is initialized
      stat:
        path: "{{ terraform_dir }}/.terraform"
      register: terraform_init

    - name: Initialize Terraform
      command: terraform init
      args:
        chdir: "{{ terraform_dir }}"
      when: not terraform_init.stat.exists
      register: terraform_init_result

    - name: Display Terraform init status
      debug:
        msg: "Terraform initialized"
      when: terraform_init_result is defined and terraform_init_result.changed

    - name: Run Terraform plan
      command: terraform plan -out=tfplan
      args:
        chdir: "{{ terraform_dir }}"
      register: terraform_plan
      changed_when: false

    - name: Display Terraform plan summary
      debug:
        msg: "{{ terraform_plan.stdout_lines[-10:] }}"

    - name: Apply Terraform changes
      command: terraform apply -auto-approve tfplan
      args:
        chdir: "{{ terraform_dir }}"
      register: terraform_apply

    - name: Extract Terraform outputs
      block:
        - name: Get github_role_arn
          command: terraform output -raw github_role_arn
          args:
            chdir: "{{ terraform_dir }}"
          register: github_role_arn_output
          changed_when: false

        - name: Get webhook_url
          command: terraform output -raw webhook_url
          args:
            chdir: "{{ terraform_dir }}"
          register: webhook_url_output
          changed_when: false
          failed_when: false

        - name: Get ai_processor_url
          command: terraform output -raw ai_processor_url
          args:
            chdir: "{{ terraform_dir }}"
          register: ai_processor_url_output
          changed_when: false
          failed_when: false

        - name: Get ai_processor_api_key
          command: terraform output -raw ai_processor_api_key
          args:
            chdir: "{{ terraform_dir }}"
          register: ai_processor_api_key_output
          changed_when: false
          failed_when: false

        - name: Store Terraform outputs
          set_fact:
            terraform_outputs:
              github_role_arn: "{{ github_role_arn_output.stdout }}"
              webhook_url: "{{ webhook_url_output.stdout | default('') }}"
              ai_processor_url: "{{ ai_processor_url_output.stdout | default('') }}"
              ai_processor_api_key: "{{ ai_processor_api_key_output.stdout | default('') }}"

        - name: Display extracted outputs
          debug:
            msg:
              - "GitHub Role ARN: {{ terraform_outputs.github_role_arn }}"
              - "Webhook URL: {{ terraform_outputs.webhook_url }}"
              - "AI Processor URL: {{ terraform_outputs.ai_processor_url }}"

    - name: Create Ansible variables file for GitHub secrets
      copy:
        content: |
          # Auto-generated by bootstrap.yml - DO NOT EDIT MANUALLY
          github_owner: "{{ github_owner }}"
          github_repo: "{{ github_repo }}"

          github_secrets:
            AWS_ROLE_TO_ASSUME: "{{ terraform_outputs.github_role_arn }}"
            AWS_REGION: "eu-west-1"
            TERRAFORM_STATE_BUCKET: "{{ terraform_state_bucket }}"
            TELEGRAM_BOT_TOKEN: "{{ telegram_bot_token }}"
            TELEGRAM_CHAT_ID: "{{ telegram_chat_id }}"
            {% if terraform_outputs.ai_processor_url %}
            CALLBACK_URL: "{{ terraform_outputs.ai_processor_url }}"
            {% endif %}
            {% if terraform_outputs.ai_processor_api_key %}
            CALLBACK_KEY: "{{ terraform_outputs.ai_processor_api_key }}"
            {% endif %}
        dest: "{{ ansible_dir }}/vars/bootstrap-secrets.yml"
        mode: '0600'
      no_log: true

    - name: Set GitHub secrets
      block:
        - name: Check if PyNaCl is installed
          command: python3 -c "import nacl"
          register: pynacl_check
          changed_when: false
          failed_when: false

        - name: Ensure PyNaCl is available for encryption
          pip:
            name: pynacl
            state: present
            extra_args: --break-system-packages
          vars:
            ansible_python_interpreter: "/usr/bin/python3"
          when: pynacl_check.rc != 0

        - name: Fetch GitHub repo public key
          uri:
            url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}/actions/secrets/public-key"
            method: GET
            headers:
              Authorization: "Bearer {{ github_token_value | default(lookup('env', 'GITHUB_TOKEN')) }}"
              Accept: "application/vnd.github+json"
            return_content: true
          register: public_key_response

        - name: Parse public key and id
          set_fact:
            gh_public_key_id: "{{ (public_key_response.json.key_id) | string }}"
            gh_public_key: "{{ public_key_response.json.key }}"

        - name: Build GitHub secrets dictionary
          set_fact:
            github_secrets_dict:
              AWS_ROLE_TO_ASSUME: "{{ terraform_outputs.github_role_arn }}"
              AWS_REGION: "eu-west-1"
              TERRAFORM_STATE_BUCKET: "{{ terraform_state_bucket }}"
              TELEGRAM_BOT_TOKEN: "{{ telegram_bot_token }}"
              TELEGRAM_CHAT_ID: "{{ telegram_chat_id }}"
              CALLBACK_URL: "{{ terraform_outputs.ai_processor_url | default('') }}"
              CALLBACK_KEY: "{{ terraform_outputs.ai_processor_api_key | default('') }}"

        - name: Encrypt secret values with repository public key
          vars:
            secret_name: "{{ item.key }}"
            secret_value: "{{ item.value }}"
          command: >-
            {{ ansible_dir }}/scripts/encrypt_github_secret.py
            --public-key {{ gh_public_key | quote }}
            --value {{ secret_value | quote }}
          loop: "{{ github_secrets_dict | dict2items }}"
          register: encrypted_values
          changed_when: false
          no_log: true

        - name: Build encrypted map
          set_fact:
            encrypted_map: "{{ dict(encrypted_values.results | map(attribute='item.key') | list | zip(encrypted_values.results | map(attribute='stdout') | list)) }}"

        - name: PUT each secret to GitHub
          vars:
            secret_name: "{{ item.key }}"
            encrypted_value: "{{ encrypted_map[secret_name] }}"
          uri:
            url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}/actions/secrets/{{ secret_name }}"
            method: PUT
            headers:
              Authorization: "Bearer {{ github_token_value | default(lookup('env', 'GITHUB_TOKEN')) }}"
              Accept: "application/vnd.github+json"
            body_format: json
            body:
              encrypted_value: "{{ encrypted_value }}"
              key_id: "{{ gh_public_key_id }}"
            status_code: [201, 204]
          loop: "{{ github_secrets_dict | dict2items }}"
          no_log: true

        - name: Display secrets set
          debug:
            msg: "âœ… Set GitHub secret: {{ item.key }}"
          loop: "{{ github_secrets_dict | dict2items }}"
          loop_control:
            label: "{{ item.key }}"

    - name: Update AWS Secrets Manager with callback URL and key
      block:
        - name: Get current secrets from Secrets Manager
          shell: |
            aws secretsmanager get-secret-value \
              --secret-id chatops/secrets \
              --region "{{ aws_region | default('eu-west-1') }}" \
              --query 'SecretString' --output text
          register: current_secrets_json
          changed_when: false
          failed_when: false
          no_log: true

        - name: Parse current secrets
          set_fact:
            current_secrets: "{{ current_secrets_json.stdout | from_json }}"
          when: current_secrets_json.rc == 0 and current_secrets_json.stdout | trim != ''
          failed_when: false

        - name: Initialize empty secrets if not found
          set_fact:
            current_secrets: {}
          when: current_secrets is not defined

        - name: Update secrets with callback URL and key
          set_fact:
            updated_secrets: "{{ current_secrets | combine({
              'callback_url': terraform_outputs.ai_processor_url | default('')
            }) }}"
          when: terraform_outputs.ai_processor_url is defined and terraform_outputs.ai_processor_url != ''

        - name: Add callback_key if api_processor_api_key is available
          set_fact:
            updated_secrets: "{{ updated_secrets | combine({
              'callback_key': terraform_outputs.ai_processor_api_key
            }) }}"
          when:
            - terraform_outputs.ai_processor_api_key is defined
            - terraform_outputs.ai_processor_api_key != ''
            - updated_secrets is defined

        - name: Update secrets without callback if URL not available
          set_fact:
            updated_secrets: "{{ current_secrets }}"
          when: terraform_outputs.ai_processor_url is not defined or terraform_outputs.ai_processor_url == ''

        - name: Update Secrets Manager secret
          shell: |
            aws secretsmanager put-secret-value \
              --secret-id chatops/secrets \
              --region "{{ aws_region | default('eu-west-1') }}" \
              --secret-string '{{ updated_secrets | to_json }}'
          when: updated_secrets is defined
          no_log: true

        - name: Display updated secret keys
          debug:
            msg: "âœ… Updated AWS Secrets Manager with callback_url and callback_key"

    - name: Set Telegram webhook URL
      block:
        - name: Set Telegram webhook
          uri:
            url: "https://api.telegram.org/bot{{ telegram_bot_token }}/setWebhook"
            method: POST
            body_format: form-urlencoded
            body:
              url: "{{ terraform_outputs.webhook_url }}"
            status_code: [200]
            return_content: true
          register: webhook_result
          no_log: true

        - name: Verify webhook was set
          uri:
            url: "https://api.telegram.org/bot{{ telegram_bot_token }}/getWebhookInfo"
            method: GET
            return_content: true
          register: webhook_info
          no_log: true

        - name: Display webhook status
          debug:
            msg:
              - "âœ… Telegram webhook configured"
              - "  URL: {{ webhook_info.json.result.url }}"
              - "  Pending updates: {{ webhook_info.json.result.pending_update_count }}"
              - "  Last error: {{ webhook_info.json.result.last_error_message | default('None') }}"

    - name: Bootstrap complete summary
      debug:
        msg:
          - "=========================================="
          - "  Bootstrap Complete! ðŸŽ‰"
          - "=========================================="
          - ""
          - "Next steps:"
          - "  1. Verify secrets in GitHub: Settings â†’ Secrets and variables â†’ Actions"
          - "  2. Test deployment: Push to dev/staging branch or trigger workflow manually"
          - "  3. Telegram webhook is automatically configured âœ…"
          - ""
          - "Terraform Outputs:"
          - "  - GitHub Role ARN: {{ terraform_outputs.github_role_arn }}"
          - "  - Webhook URL: {{ terraform_outputs.webhook_url }}"
          - "  - AI Processor URL: {{ terraform_outputs.ai_processor_url }}"
