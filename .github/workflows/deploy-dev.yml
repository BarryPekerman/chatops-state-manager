name: Deploy to Dev

on:
  # Trigger after Lambda CI/CD completes successfully
  workflow_run:
    workflows: ["Lambda CI/CD"]
    types:
      - completed
    branches:
      - dev
  # Also trigger on push to dev (will check CI status)
  push:
    branches:
      - dev
    paths:
      - 'lambda/**'
      - 'terraform/**'
      - '.github/workflows/deploy-dev.yml'
  # Allow manual triggers
  workflow_dispatch:
    inputs:
      skip_ci_check:
        description: 'Skip waiting for CI (use with caution)'
        required: false
        default: 'false'
        type: boolean

# Require that CI passes before deployment
concurrency:
  group: deploy-dev
  cancel-in-progress: false

jobs:
  # Check if CI workflow succeeded (unless manually skipped)
  check-ci-status:
    name: Check CI Status
    runs-on: ubuntu-latest
    # Only proceed if CI succeeded OR manual dispatch with skip flag OR push (will check CI status)
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch' && (inputs.skip_ci_check == 'true' || inputs.skip_ci_check == true)) ||
      github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install jq (if needed)
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          else
            echo "jq is already installed"
          fi
      
      - name: Verify CI passed
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "âœ… Lambda CI/CD completed successfully (workflow_run trigger)"
            echo "CI workflow run: ${{ github.event.workflow_run.html_url }}"
            echo "CI workflow SHA: ${{ github.event.workflow_run.head_sha }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "ðŸ” Checking if Lambda CI/CD has passed for commit ${{ github.sha }}"
            # Wait a bit for CI to potentially complete
            sleep 10
            # Check CI status using GitHub API
            CI_STATUS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs?branch=dev&head_sha=${{ github.sha }}&per_page=5" | \
              jq -r '.workflow_runs[] | select(.name == "Lambda CI/CD") | .conclusion' | head -1)
            
            if [ "$CI_STATUS" = "success" ]; then
              echo "âœ… Lambda CI/CD has passed for this commit"
            elif [ "$CI_STATUS" = "failure" ] || [ "$CI_STATUS" = "cancelled" ]; then
              echo "âŒ Lambda CI/CD has failed or was cancelled for this commit"
              echo "âš ï¸ Proceeding anyway, but deployment may fail"
            elif [ -z "$CI_STATUS" ]; then
              echo "âš ï¸ Lambda CI/CD status not found yet - it may still be running"
              echo "âš ï¸ Proceeding, but ensure CI passes before deploying to production"
            else
              echo "âš ï¸ Lambda CI/CD status: $CI_STATUS"
              echo "âš ï¸ Proceeding, but ensure CI passes before deploying"
            fi
          else
            echo "âš ï¸ Manual trigger with CI check skipped"
            echo "âš ï¸ Make sure Lambda CI/CD has completed for this commit"
          fi
  
  # Download artifacts from CI build
  prepare-artifacts:
    name: Prepare Artifacts
    runs-on: ubuntu-latest
    needs: check-ci-status
    # Use the workflow_run SHA if available, otherwise use current SHA
    env:
      WORKFLOW_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.WORKFLOW_SHA }}
      
      - name: Download webhook-handler artifact
        uses: actions/download-artifact@v4
        with:
          name: webhook-handler-${{ env.WORKFLOW_SHA }}
          path: ./artifacts/
        continue-on-error: true
      
      - name: Download ai-processor artifact
        uses: actions/download-artifact@v4
        with:
          name: ai-output-processor-${{ env.WORKFLOW_SHA }}
          path: ./artifacts/
        continue-on-error: true
      
      - name: Download telegram-bot artifact
        uses: actions/download-artifact@v4
        with:
          name: telegram-bot-${{ env.WORKFLOW_SHA }}
          path: ./artifacts/
        continue-on-error: true
      
      - name: Build artifacts if not found
        run: |
          # Create artifacts directory if it doesn't exist
          mkdir -p ./artifacts/
          
          if [ ! -f ./artifacts/lambda_function.zip ]; then
            echo "Building webhook-handler..."
            cd lambda/webhook-handler && ./build.sh && mv lambda_function.zip ../../artifacts/
          fi
          if [ ! -f ./artifacts/output_processor.zip ]; then
            echo "Building ai-output-processor..."
            cd lambda/ai-output-processor && ./build.sh && mv output_processor.zip ../../artifacts/
          fi
          if [ ! -f ./artifacts/telegram-bot.zip ]; then
            echo "Building telegram-bot..."
            cd lambda/telegram-bot && ./build.sh && mv telegram-bot.zip ../../artifacts/
          fi
      
      - name: Verify artifacts exist
        run: |
          echo "Checking for artifacts..."
          ls -lh ./artifacts/ || echo "No artifacts directory found"
          if [ ! -f ./artifacts/lambda_function.zip ] && [ ! -f ./artifacts/output_processor.zip ] && [ ! -f ./artifacts/telegram-bot.zip ]; then
            echo "ERROR: No artifacts found after build fallback!"
            exit 1
          fi
      
      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lambda-artifacts-dev-${{ env.WORKFLOW_SHA }}
          path: ./artifacts/*.zip
          retention-days: 7
          if-no-files-found: error
  
  # Deploy to dev environment
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: prepare-artifacts
    environment:
      name: dev
      url: https://dev.chatops.example.com
    
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-artifacts-dev-${{ github.event.workflow_run.head_sha || github.sha }}
          path: ./terraform/artifacts/
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=dev/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}"
      
      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="environment=dev" \
            -var="webhook_lambda_zip_path=./artifacts/lambda_function.zip" \
            -var="output_processor_zip_path=./artifacts/output_processor.zip" \
            -var="telegram_lambda_zip_path=./artifacts/telegram-bot.zip" \
            -var="github_token=${{ secrets.GITHUB_TOKEN }}" \
            -var="telegram_bot_token=${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -var="authorized_chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -out=tfplan
      
      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan
      
      - name: Get outputs
        id: terraform
        working-directory: ./terraform
        run: |
          echo "webhook_url=$(terraform output -raw webhook_url)" >> $GITHUB_OUTPUT
          echo "ai_processor_url=$(terraform output -raw ai_processor_url)" >> $GITHUB_OUTPUT
          echo "github_role_arn=$(terraform output -raw github_role_arn)" >> $GITHUB_OUTPUT
      
      - name: Display GitHub Role ARN
        run: |
          echo "## ðŸ“‹ GitHub OIDC Role ARN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Role ARN:** \`${{ steps.terraform.outputs.github_role_arn }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> â„¹ï¸ **Note:** This role is created by Terraform. Use \`AWS_ROLE_TO_ASSUME\` secret for all environments." >> $GITHUB_STEP_SUMMARY
      
      - name: Deployment summary
        run: |
          echo "# ðŸš€ Dev Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ secrets.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Webhook URL:** ${{ steps.terraform.outputs.webhook_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Lambda Functions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… webhook-handler deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ai-output-processor deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… telegram-bot deployed" >> $GITHUB_STEP_SUMMARY
  
  # Run smoke tests against dev
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests boto3
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against dev..."
          # Test webhook endpoint is accessible
          curl -f -X OPTIONS ${{ secrets.DEV_WEBHOOK_URL }} || echo "Warning: CORS preflight failed"
          
          # Test that secrets are accessible
          aws secretsmanager describe-secret --secret-id chatops/secrets --region ${{ secrets.AWS_REGION }} || echo "Warning: Secrets not found"
      
      - name: Smoke test summary
        run: |
          echo "# âœ… Smoke Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "Dev environment is healthy and ready for testing" >> $GITHUB_STEP_SUMMARY

